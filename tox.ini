[tox]
envlist = py39, py310, py311, py312, lint, type, coverage
isolated_build = true
skip_missing_interpreters = true

[testenv]
deps =
    pytest>=7.0
    pytest-cov>=4.0
    pytest-mock>=3.10
    pytest-asyncio>=0.21
    pytest-benchmark>=4.0
    memory-profiler>=0.61
    fastapi>=0.100
    httpx>=0.24
    ijson>=3.2
    pynvml>=11.5
    aiofiles>=23.0
    pyyaml>=6.0

commands =
    pytest {posargs:tests}

passenv = 
    HOME
    USER
    CI
    GITHUB_*

[testenv:py39]
basepython = python3.9

[testenv:py310]
basepython = python3.10

[testenv:py311]
basepython = python3.11

[testenv:py312]
basepython = python3.12

[testenv:lint]
deps =
    ruff>=0.1.0
    black>=23.0
    isort>=5.12
    flake8>=6.0
    flake8-docstrings>=1.7
    flake8-bugbear>=23.0
    flake8-comprehensions>=3.14
    pylint>=3.0

commands =
    black --check --diff shared op1_large op2_lite tests
    isort --check-only --diff shared op1_large op2_lite tests
    ruff check shared op1_large op2_lite tests
    flake8 shared op1_large op2_lite tests
    pylint shared op1_large op2_lite tests

[testenv:format]
deps =
    black>=23.0
    isort>=5.12
    ruff>=0.1.0

commands =
    black shared op1_large op2_lite tests
    isort shared op1_large op2_lite tests
    ruff check --fix shared op1_large op2_lite tests

[testenv:type]
deps =
    mypy>=1.7
    types-pyyaml
    types-aiofiles
    pandas-stubs

commands =
    mypy --strict shared op1_large op2_lite

[testenv:coverage]
deps =
    {[testenv]deps}
    coverage[toml]>=7.0

commands =
    coverage erase
    coverage run -m pytest tests
    coverage report
    coverage html
    coverage xml

[testenv:benchmark]
deps =
    {[testenv]deps}

commands =
    pytest tests --benchmark-only --benchmark-autosave --benchmark-histogram

[testenv:integration]
deps =
    {[testenv]deps}
    docker>=6.1
    docker-compose>=1.29

commands =
    pytest tests -m integration

[testenv:docs]
deps =
    sphinx>=7.0
    sphinx-rtd-theme>=1.3
    sphinx-autodoc-typehints>=1.24
    myst-parser>=2.0

commands =
    sphinx-build -W -b html docs docs/_build/html

[testenv:security]
deps =
    bandit[toml]>=1.7
    safety>=2.3
    pip-audit>=2.6

commands =
    bandit -r shared op1_large op2_lite
    safety check
    pip-audit

[testenv:clean]
deps =
skip_install = true
commands =
    python -c "import shutil; shutil.rmtree('.tox', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.pytest_cache', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('htmlcov', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.coverage', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('build', ignore_errors=True)"
    python -c "import pathlib; [p.unlink() for p in pathlib.Path('.').rglob('*.pyc')]"
    python -c "import pathlib; [p.unlink() for p in pathlib.Path('.').rglob('*.pyo')]"
    python -c "import pathlib; [p.rmdir() for p in pathlib.Path('.').rglob('__pycache__')]"

[testenv:dev]
deps =
    {[testenv]deps}
    ipython>=8.0
    ipdb>=0.13

commands =
    python -m ipython

[gh-actions]
python =
    3.9: py39
    3.10: py310
    3.11: py311
    3.12: py312

[flake8]
max-line-length = 120
extend-ignore = E203, E266, E501, W503
max-complexity = 15
exclude = .git,__pycache__,docs/source/conf.py,old,build,dist,.tox,venv
select = B,C,E,F,W,T4,B9

[isort]
profile = black
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
line_length = 120
skip_gitignore = true

[mypy]
python_version = 3.9
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
disallow_any_generics = true
check_untyped_defs = true
no_implicit_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
strict_equality = true